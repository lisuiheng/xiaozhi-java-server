<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.github.lisuiheng.astra.sys.mapper.SysRoleMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="SysRoleResultMap" type="com.github.lisuiheng.astra.sys.domain.vo.SysRoleVo">
        <id property="roleId" column="role_id"/>
        <result property="roleName" column="role_name"/>
        <result property="roleKey" column="role_key"/>
        <result property="roleSort" column="role_sort"/>
        <result property="dataScope" column="data_scope"/>
        <result property="menuCheckStrictly" column="menu_check_strictly"/>
        <result property="deptCheckStrictly" column="dept_check_strictly"/>
        <result property="status" column="status"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="remark" column="remark"/>
    </resultMap>

    <!-- 通用查询结果列 -->
    <sql id="selectSysRoleVo">
        select role_id, role_name, role_key, role_sort, data_scope, menu_check_strictly, dept_check_strictly, 
               status, create_time, update_time, remark
        from sys_role
    </sql>

    <!-- 分页查询角色列表 -->
    <select id="selectPageRoleList" resultMap="SysRoleResultMap">
        <include refid="selectSysRoleVo"/>
        <where>
            <if test="role.roleName != null and role.roleName != ''">
                AND role_name like concat('%', #{role.roleName}, '%')
            </if>
            <if test="role.status != null and role.status != ''">
                AND status = #{role.status}
            </if>
            <if test="role.roleKey != null and role.roleKey != ''">
                AND role_key like concat('%', #{role.roleKey}, '%')
            </if>
            AND del_flag = '0'
        </where>
        ORDER BY role_sort
    </select>

    <!-- 查询角色列表 -->
    <select id="selectRoleList" resultMap="SysRoleResultMap">
        <include refid="selectSysRoleVo"/>
        <where>
            <if test="role.roleName != null and role.roleName != ''">
                AND role_name like concat('%', #{role.roleName}, '%')
            </if>
            <if test="role.status != null and role.status != ''">
                AND status = #{role.status}
            </if>
            <if test="role.roleKey != null and role.roleKey != ''">
                AND role_key like concat('%', #{role.roleKey}, '%')
            </if>
            AND del_flag = '0'
        </where>
        ORDER BY role_sort
    </select>

    <!-- 根据角色ID查询角色 -->
    <select id="selectRoleById" parameterType="long" resultMap="SysRoleResultMap">
        <include refid="selectSysRoleVo"/>
        WHERE role_id = #{roleId} AND del_flag = '0'
    </select>

    <!-- 根据用户ID查询角色列表 -->
    <select id="selectRolesByUserId" parameterType="long" resultMap="SysRoleResultMap">
        SELECT DISTINCT r.role_id, r.role_name, r.role_key, r.role_sort, r.data_scope, r.menu_check_strictly,
                        r.dept_check_strictly, r.status, r.create_time, r.update_time, r.remark
        FROM sys_role r
        LEFT JOIN sys_user_role ur ON ur.role_id = r.role_id
        LEFT JOIN sys_user u ON u.user_id = ur.user_id
        WHERE r.del_flag = '0' AND u.user_id = #{userId}
        ORDER BY r.role_sort
    </select>

    <!-- 查询所有角色 -->
    <select id="selectRoleAll" resultMap="SysRoleResultMap">
        <include refid="selectSysRoleVo"/>
        WHERE del_flag = '0'
        ORDER BY role_sort
    </select>

</mapper>